<%- include('../partials/header', { pageTitle: pageTitle }) %>
<section class="page-header">
  <div>
    <h1>Ticket #<%= ticket.public_id %></h1>
    <p><%= ticket.subject || 'Support ticket' %></p>
  </div>
  <div class="meta">
    <span class="pill"><%= ticket.status_name || 'Open' %></span>
    <span><%= ticket.panel_name || 'General' %></span>
  </div>
</section>

<section class="card">
  <form class="inline" method="post" action="/staff/tickets/<%= ticket.public_id %>/claim">
    <% if (ticket.assigned_staff_id) { %>
      <input type="hidden" name="action" value="unclaim">
      <button class="btn secondary" type="submit">Unclaim</button>
    <% } else { %>
      <input type="hidden" name="action" value="claim">
      <button class="btn" type="submit">Claim</button>
    <% } %>
  </form>
  <form class="inline" method="post" action="/staff/tickets/<%= ticket.public_id %>/status">
    <select name="status_id">
      <% statuses.forEach((status) => { %>
        <option value="<%= status.id %>" <%= String(status.id) === String(ticket.status_id) ? 'selected' : '' %>><%= status.name %></option>
      <% }) %>
    </select>
    <button class="btn secondary" type="submit">Update status</button>
  </form>
  <form class="inline" method="post" action="/staff/tickets/<%= ticket.public_id %>/assign">
    <select name="staff_id">
      <option value="">Unassigned</option>
      <% staffMembers.forEach((staff) => { %>
        <option value="<%= staff.id %>" <%= String(staff.id) === String(ticket.assigned_staff_id) ? 'selected' : '' %>><%= staff.discord_username || staff.discord_id %></option>
      <% }) %>
    </select>
    <button class="btn secondary" type="submit">Assign</button>
  </form>
</section>

<section class="thread">
  <% messages.forEach((msg) => { %>
    <article class="message">
      <div class="message-meta">
        <% const authorName = msg.author_username || (msg.author_type === 'staff' ? 'Staff' : 'User'); %>
        <% const roleName = msg.author_type === 'staff' ? (msg.author_role_name || (msg.author_is_admin ? 'Admin' : 'Staff')) : 'User'; %>
        <% const roleClass = msg.author_type === 'staff' ? (msg.author_is_admin ? 'role-admin' : 'role-staff') : 'role-user'; %>
        <% const avatarIndex = msg.author_discord_id ? (parseInt(String(msg.author_discord_id).slice(-1), 10) || 0) % 5 : 0; %>
        <% const avatarUrl = msg.author_avatar && msg.author_discord_id ? `https://cdn.discordapp.com/avatars/${msg.author_discord_id}/${msg.author_avatar}.png?size=64` : `https://cdn.discordapp.com/embed/avatars/${avatarIndex}.png`; %>
        <div class="message-author">
          <img class="message-avatar" src="<%= avatarUrl %>" alt="<%= authorName %> avatar" loading="lazy">
          <div class="author-info">
            <span class="author-name"><%= authorName %></span>
            <span class="role-pill <%= roleClass %>"><%= roleName %></span>
          </div>
        </div>
        <span class="message-time"><%= msg.created_at %></span>
      </div>
      <pre class="message-body"><%= msg.body %></pre>
      <% const attachments = attachmentsByMessage.get(msg.id) || []; %>
      <% if (attachments.length) { %>
        <div class="attachments">
          <% attachments.forEach((att) => { %>
            <% if (att.storage_url) { %>
              <a href="<%= att.storage_url %>" target="_blank" rel="noopener">ðŸ“Ž <%= att.filename %></a>
            <% } else { %>
              <a href="/attachments/<%= att.id %>" target="_blank" rel="noopener">ðŸ“Ž <%= att.filename %></a>
            <% } %>
          <% }) %>
        </div>
      <% } %>
    </article>
  <% }) %>
</section>

<section class="card">
  <h3>Reply</h3>
  <form class="form" method="post" action="/staff/tickets/<%= ticket.public_id %>/reply" enctype="multipart/form-data">
    <textarea name="message" rows="4" required></textarea>
    <label>
      Attachments
      <input type="file" name="attachments" multiple>
    </label>
    <button class="btn" type="submit">Send reply</button>
  </form>
</section>
<%- include('../partials/footer', { useSse: useSse }) %>
